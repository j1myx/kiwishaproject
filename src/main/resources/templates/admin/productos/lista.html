<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
          href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Work+Sans%3Awght%40400%3B500%3B700%3B900"/>
    <title>Gestión de Productos - Achisway</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div class="relative flex h-auto min-h-screen w-full flex-col bg-[#fcfaf8] group/design-root overflow-x-hidden" 
     style='font-family: "Work Sans", "Noto Sans", sans-serif;'>
    <div class="layout-container flex h-full grow flex-col">
        
        <!-- Header -->
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#f4ede6] px-10 py-3">
            <div class="flex items-center gap-4 text-[#1c140d]">
                <div class="size-4">
                    <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 6H42L36 24L42 42H6L12 24L6 6Z" fill="currentColor"></path>
                    </svg>
                </div>
                <h2 class="text-[#1c140d] text-lg font-bold leading-tight tracking-[-0.015em]">Achisway</h2>
            </div>
            <div class="flex flex-1 justify-end gap-8">
                <div class="flex items-center gap-9">
                    <a class="text-[#1c140d] text-sm font-medium leading-normal" th:href="@{/}">Inicio</a>
                    <a class="text-[#1c140d] text-sm font-medium leading-normal" th:href="@{/productos}">Productos</a>
                    <a class="text-[#1c140d] text-sm font-medium leading-normal" href="#">Nosotros</a>
                    <a class="text-[#1c140d] text-sm font-medium leading-normal" href="#">Contacto</a>
                </div>
                <a th:href="@{/admin/dashboard}"
                   class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#f98006] text-[#1c140d] text-sm font-bold leading-normal tracking-[0.015em]">
                    <span class="truncate">Dashboard</span>
                </a>
            </div>
        </header>
        
        <!-- Contenedor principal con padding -->
        <div class="px-40 flex flex-1 justify-center py-5">
        <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            
            <!-- Header con título y botón Nuevo producto -->
            <div class="flex flex-wrap justify-between gap-3 p-4">
                <p class="text-[#1c140d] tracking-light text-[32px] font-bold leading-tight min-w-72">Listado de Productos</p>
                <a th:href="@{/admin/productos/nuevo}"
                   class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-8 px-4 bg-[#f4ede6] text-[#1c140d] text-sm font-medium leading-normal hover:bg-[#e9dbce] transition-colors">
                    <span class="truncate">Nuevo producto</span>
                </a>
            </div>

            <!-- Barra de búsqueda -->
            <div class="px-4 py-3">
                <label class="flex flex-col min-w-40 h-12 w-full">
                    <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                        <div class="text-[#9e7347] flex border-none bg-[#f4ede6] items-center justify-center pl-4 rounded-l-lg border-r-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path>
                            </svg>
                        </div>
                        <input
                            id="searchInput"
                            type="text"
                            placeholder="Buscar productos..."
                            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#1c140d] focus:outline-0 focus:ring-0 border-none bg-[#f4ede6] focus:border-none h-full placeholder:text-[#9e7347] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal"
                        />
                    </div>
                </label>
            </div>

            <!-- Filtros -->
            <div class="flex gap-3 p-3 flex-wrap pr-4">
                <!-- Filtro de Categoría -->
                <select id="categoriaFilter" onchange="aplicarFiltros()" 
                        class="h-8 min-w-[200px] rounded-lg bg-[#f4ede6] px-3 pr-8 text-[#1c140d] text-sm font-medium hover:bg-[#e9dbce] transition-colors border-0 outline-none cursor-pointer">
                    <option value="">Todas las categorías</option>
                    <option th:each="categoria : ${categorias}" 
                            th:value="${categoria.categoriaId}" 
                            th:text="${categoria.titulo}">Granos Andinos</option>
                </select>
                
                <!-- Filtro de Estado -->
                <select id="estadoFilter" onchange="aplicarFiltros()" 
                        class="h-8 min-w-[180px] rounded-lg bg-[#f4ede6] px-3 pr-8 text-[#1c140d] text-sm font-medium hover:bg-[#e9dbce] transition-colors border-0 outline-none cursor-pointer">
                    <option value="">Todos los estados</option>
                    <option value="BORRADOR">Borrador</option>
                    <option value="PUBLICADO">Publicado</option>
                    <option value="ARCHIVADO">Archivado</option>
                </select>
                
                <!-- Filtro de Precio -->
                <select id="precioFilter" onchange="aplicarFiltros()" 
                        class="h-8 min-w-[180px] rounded-lg bg-[#f4ede6] px-3 pr-8 text-[#1c140d] text-sm font-medium hover:bg-[#e9dbce] transition-colors border-0 outline-none cursor-pointer">
                    <option value="">Todos los precios</option>
                    <option value="0-10">S/ 0 - S/ 10</option>
                    <option value="10-20">S/ 10 - S/ 20</option>
                    <option value="20-50">S/ 20 - S/ 50</option>
                    <option value="50-999999">S/ 50+</option>
                </select>
                
                <!-- Botón para limpiar filtros -->
                <button onclick="limpiarFiltros()" 
                        class="h-8 shrink-0 rounded-lg bg-[#f98006] px-4 text-white text-sm font-medium hover:bg-[#e07205] transition-colors">
                    Limpiar filtros
                </button>
            </div>

            <!-- Tabla de productos -->
            <div class="px-4 py-3 @container">
                <div class="flex overflow-hidden rounded-lg border border-[#e9dbce] bg-[#fcfaf8]">
                    <table class="flex-1">
                        <thead>
                            <tr class="bg-[#fcfaf8]">
                                <th class="px-4 py-3 text-left text-[#1c140d] w-[400px] text-sm font-medium leading-normal">Nombre</th>
                                <th class="px-4 py-3 text-left text-[#1c140d] w-[400px] text-sm font-medium leading-normal">SKU</th>
                                <th class="px-4 py-3 text-left text-[#1c140d] w-[400px] text-sm font-medium leading-normal">Categoría</th>
                                <th class="px-4 py-3 text-left text-[#1c140d] w-[400px] text-sm font-medium leading-normal">Precio</th>
                                <th class="px-4 py-3 text-left text-[#1c140d] w-[400px] text-sm font-medium leading-normal">Stock</th>
                                <th class="px-4 py-3 text-left text-[#1c140d] w-60 text-sm font-medium leading-normal">Estado</th>
                                <th class="px-4 py-3 text-left text-[#1c140d] w-[400px] text-sm font-medium leading-normal">Última actualización</th>
                                <th class="px-4 py-3 text-left text-[#1c140d] w-60 text-[#9e7347] text-sm font-medium leading-normal">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${productos == null || productos.empty}" class="border-t border-t-[#e9dbce]">
                                <td colspan="8" class="h-[72px] px-4 py-2 text-center text-[#9e7347] text-sm font-normal leading-normal">
                                    No se encontraron productos
                                </td>
                            </tr>

                            <tr th:each="producto : ${productos}" 
                                class="border-t border-t-[#e9dbce] hover:bg-[#f4ede6] transition-colors producto-row"
                                th:data-categoria-id="${producto.categoriaId}"
                                th:data-estado="${producto.estado.name()}"
                                th:data-precio="${producto.precio}">
                                <td class="h-[72px] px-4 py-2 w-[400px] text-[#1c140d] text-sm font-normal leading-normal" 
                                    th:text="${producto.titulo}">Kiwicha Orgánica</td>
                                <td class="h-[72px] px-4 py-2 w-[400px] text-[#9e7347] text-sm font-normal leading-normal" 
                                    th:text="${producto.sku}">KIW-ORG-001</td>
                                <td class="h-[72px] px-4 py-2 w-[400px] text-[#9e7347] text-sm font-normal leading-normal" 
                                    th:text="${producto.categoriaNombre != null ? producto.categoriaNombre : 'Sin categoría'}">Granos</td>
                                <td class="h-[72px] px-4 py-2 w-[400px] text-[#9e7347] text-sm font-normal leading-normal" 
                                    th:text="${'S/ ' + #numbers.formatDecimal(producto.precio, 1, 2)}">S/ 5.99</td>
                                <td class="h-[72px] px-4 py-2 w-[400px] text-sm font-normal leading-normal"
                                    th:classappend="${producto.cantidad < 10 ? 'text-red-600 font-bold' : 'text-[#9e7347]'}"
                                    th:text="${producto.cantidad}">150</td>
                                <td class="h-[72px] px-4 py-2 w-60 text-sm font-normal leading-normal">
                                    <button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-8 px-4 bg-[#f4ede6] text-[#1c140d] text-sm font-medium leading-normal w-full"
                                            th:text="${producto.estado.name() == 'PUBLICADO' ? 'Publicado' : (producto.estado.name() == 'BORRADOR' ? 'Borrador' : 'Archivado')}">
                                        <span class="truncate">Publicado</span>
                                    </button>
                                </td>
                                <td class="h-[72px] px-4 py-2 w-[400px] text-[#9e7347] text-sm font-normal leading-normal" 
                                    th:text="${#temporals.format(producto.actualizadoEn != null ? producto.actualizadoEn : producto.creadoEn, 'yyyy-MM-dd')}">2024-01-15</td>
                                <td class="h-[72px] px-4 py-2 w-60">
                                    <div class="flex items-center gap-3">
                                        <a th:href="@{/admin/productos/{id}/editar(id=${producto.productoId})}" 
                                           class="text-[#9e7347] hover:text-[#f98006] text-sm font-medium transition-colors">
                                            Editar
                                        </a>
                                        <span class="text-[#e9dbce]">|</span>
                                        <a href="javascript:void(0)" 
                                           th:data-producto-id="${producto.productoId}"
                                           onclick="duplicarProducto(this.getAttribute('data-producto-id'))"
                                           class="text-[#9e7347] hover:text-[#f98006] text-sm font-medium transition-colors">
                                            Duplicar
                                        </a>
                                        <span class="text-[#e9dbce]">|</span>
                                        <a href="javascript:void(0)" 
                                           th:data-producto-id="${producto.productoId}"
                                           th:data-producto-titulo="${producto.titulo}"
                                           onclick="confirmarEliminar(this.getAttribute('data-producto-id'), this.getAttribute('data-producto-titulo'))"
                                           class="text-[#9e7347] hover:text-red-600 text-sm font-medium transition-colors">
                                            Eliminar
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Paginación -->
            <div class="flex items-center justify-center p-4">
                <a href="#" class="flex size-10 items-center justify-center hover:bg-[#f4ede6] rounded-full transition-colors">
                    <div class="text-[#1c140d]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"></path>
                        </svg>
                    </div>
                </a>
                <a class="text-sm font-bold leading-normal tracking-[0.015em] flex size-10 items-center justify-center text-[#1c140d] rounded-full bg-[#f4ede6]" href="#">1</a>
                <a class="text-sm font-normal leading-normal flex size-10 items-center justify-center text-[#1c140d] rounded-full hover:bg-[#f4ede6] transition-colors" href="#">2</a>
                <a class="text-sm font-normal leading-normal flex size-10 items-center justify-center text-[#1c140d] rounded-full hover:bg-[#f4ede6] transition-colors" href="#">3</a>
                <span class="text-sm font-normal leading-normal flex size-10 items-center justify-center text-[#1c140d] rounded-full">...</span>
                <a class="text-sm font-normal leading-normal flex size-10 items-center justify-center text-[#1c140d] rounded-full hover:bg-[#f4ede6] transition-colors" href="#">10</a>
                <a href="#" class="flex size-10 items-center justify-center hover:bg-[#f4ede6] rounded-full transition-colors">
                    <div class="text-[#1c140d]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"></path>
                        </svg>
                    </div>
                </a>
            </div>

        </div>
    </div>

    <script th:inline="javascript">
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

        // Función de búsqueda (trabaja en conjunto con filtros)
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('tbody tr.producto-row');
            
            const categoriaFiltro = document.getElementById('categoriaFilter').value;
            const estadoFiltro = document.getElementById('estadoFilter').value;
            const precioFiltro = document.getElementById('precioFilter').value;
            
            rows.forEach(row => {
                let mostrar = true;
                
                // Aplicar búsqueda de texto
                if (query) {
                    const text = Array.from(row.cells).slice(0, 3).map(cell => cell.textContent.toLowerCase()).join(' ');
                    if (!text.includes(query)) {
                        mostrar = false;
                    }
                }
                
                // Aplicar filtros (solo si pasa la búsqueda)
                if (mostrar) {
                    if (categoriaFiltro && row.dataset.categoriaId !== categoriaFiltro) {
                        mostrar = false;
                    }
                    if (estadoFiltro && row.dataset.estado !== estadoFiltro) {
                        mostrar = false;
                    }
                    if (precioFiltro) {
                        const precio = parseFloat(row.dataset.precio);
                        const [min, max] = precioFiltro.split('-').map(Number);
                        if (precio < min || precio > max) {
                            mostrar = false;
                        }
                    }
                }
                
                row.style.display = mostrar ? '' : 'none';
            });
        });

        function duplicarProducto(id) {
            if (!confirm('¿Duplicar este producto?')) return;
            console.log('Duplicando producto:', id);
            fetch(`/admin/productos/${id}/duplicar`, {
                method: 'POST',
                headers: { 
                    [csrfHeader]: csrfToken, 
                    'Content-Type': 'application/json' 
                }
            }).then(r => r.json()).then(d => {
                console.log('Respuesta duplicar:', d);
                if (d.status === 'success') {
                    alert('Producto duplicado exitosamente');
                    window.location.href = `/admin/productos/${d.nuevoId}/editar`;
                } else {
                    alert('Error: ' + (d.mensaje || 'No se pudo duplicar'));
                }
            }).catch(error => {
                console.error('Error al duplicar:', error);
                alert('Error al duplicar el producto');
            });
        }

        function confirmarEliminar(id, titulo) {
            console.log('Eliminar llamado con:', id, titulo);
            if (!confirm(`¿Está seguro de eliminar el producto "${titulo}"?`)) {
                console.log('Usuario canceló');
                return;
            }
            console.log('Enviando POST a:', `/admin/productos/${id}/eliminar`);
            fetch(`/admin/productos/${id}/eliminar`, {
                method: 'POST',
                headers: { 
                    [csrfHeader]: csrfToken,
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                console.log('Respuesta:', response.status);
                if (response.ok) {
                    alert('Producto eliminado exitosamente');
                    window.location.reload();
                } else {
                    return response.json().then(data => {
                        alert('Error: ' + (data.message || 'No se pudo eliminar el producto'));
                    });
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar el producto');
            });
        }

        // Función para aplicar filtros
        function aplicarFiltros() {
            console.log('Aplicando filtros...');
            const categoriaFiltro = document.getElementById('categoriaFilter').value;
            const estadoFiltro = document.getElementById('estadoFilter').value;
            const precioFiltro = document.getElementById('precioFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            console.log('Filtros activos:', { categoriaFiltro, estadoFiltro, precioFiltro, searchQuery });
            
            const rows = document.querySelectorAll('tbody tr.producto-row');
            let visibleCount = 0;
            
            rows.forEach(row => {
                let mostrar = true;
                
                // Aplicar búsqueda de texto si hay query
                if (searchQuery) {
                    const text = Array.from(row.cells).slice(0, 3).map(cell => cell.textContent.toLowerCase()).join(' ');
                    if (!text.includes(searchQuery)) {
                        mostrar = false;
                    }
                }
                
                // Aplicar filtros (solo si pasa la búsqueda)
                if (mostrar) {
                    // Filtro por categoría
                    if (categoriaFiltro && row.dataset.categoriaId !== categoriaFiltro) {
                        mostrar = false;
                    }
                    
                    // Filtro por estado
                    if (estadoFiltro && row.dataset.estado !== estadoFiltro) {
                        mostrar = false;
                    }
                    
                    // Filtro por precio
                    if (precioFiltro) {
                        const precio = parseFloat(row.dataset.precio);
                        const [min, max] = precioFiltro.split('-').map(Number);
                        if (precio < min || precio > max) {
                            mostrar = false;
                        }
                    }
                }
                
                row.style.display = mostrar ? '' : 'none';
                if (mostrar) visibleCount++;
            });
            
            console.log(`Mostrando ${visibleCount} de ${rows.length} productos`);
        }

        // Función para limpiar filtros
        function limpiarFiltros() {
            console.log('Limpiando filtros...');
            document.getElementById('categoriaFilter').value = '';
            document.getElementById('estadoFilter').value = '';
            document.getElementById('precioFilter').value = '';
            document.getElementById('searchInput').value = '';
            aplicarFiltros();
        }
    </script>
    
    </div>
</div>
</body>
</html>
