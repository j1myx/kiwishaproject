<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title th:text="${producto != null and producto.titulo != null ? producto.titulo + ' - Achisway' : 'Producto - Achisway'}">Producto - Achisway</title>
</head>
<body>

<main layout:fragment="content">
        <div class="px-40 flex flex-1 justify-center py-5">
            <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
                <!-- Breadcrumb -->
                <div class="flex flex-wrap gap-2 p-4">
                    <a class="text-[#9e7347] text-base font-medium leading-normal" th:href="@{/}">Inicio</a>
                    <span class="text-[#9e7347] text-base font-medium leading-normal">/</span>
                    <a class="text-[#9e7347] text-base font-medium leading-normal" th:href="@{/catalogo}">Catálogo</a>
                    <span class="text-[#9e7347] text-base font-medium leading-normal">/</span>
                    <span class="text-[#1c140d] text-base font-medium leading-normal" th:text="${producto.titulo}">Producto</span>
                </div>

                <!-- PDP Layout: Galería + Info -->
                <div class="grid grid-cols-1 @[720px]:grid-cols-2 gap-6 p-4"
                     th:with="imgPrincipal=${producto.imagen != null and !#strings.isEmpty(producto.imagen) ? (#strings.startsWith(producto.imagen,'http') ? producto.imagen : '/files/' + producto.imagen) : '/files/defaults/producto-default.svg'}">
                    <!-- Columna izquierda: galería -->
                    <div>
                        <div class="w-full overflow-hidden rounded-lg border border-solid border-[#f4ede6] bg-white">
                            <img id="pdpMainImage" th:src="${imgPrincipal}" alt="Imagen del producto" class="w-full object-cover aspect-[3/2]" />
                        </div>

                        <div class="flex gap-3 pt-3 overflow-x-auto [-ms-scrollbar-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden">
                            <button type="button" class="shrink-0 rounded-lg border border-solid border-[#f4ede6] overflow-hidden"
                                    th:attr="data-src=${imgPrincipal}" onclick="pdpSetMainImage(this)">
                                <img th:src="${imgPrincipal}" alt="Miniatura" class="h-20 w-28 object-cover" />
                            </button>
                            <button th:each="imgRuta : ${imagenesAdicionales}" type="button"
                                    class="shrink-0 rounded-lg border border-solid border-[#f4ede6] overflow-hidden"
                                    th:with="thumb=${imgRuta != null and !#strings.isEmpty(imgRuta) ? (#strings.startsWith(imgRuta,'http') ? imgRuta : '/files/' + imgRuta) : '/files/defaults/producto-default.svg'}"
                                    th:attr="data-src=${thumb}" onclick="pdpSetMainImage(this)">
                                <img th:src="${thumb}" alt="Miniatura" class="h-20 w-28 object-cover" />
                            </button>
                        </div>
                    </div>

                    <!-- Columna derecha: info -->
                    <div class="flex flex-col">
                        <h1 class="text-[#1c140d] text-[28px] font-bold leading-tight tracking-[-0.015em] pb-2"
                            th:text="${producto.titulo}">Producto</h1>

                        <p class="text-[#9e7347] text-sm font-normal leading-normal pb-3"
                           th:text="${producto.resumen != null and !#strings.isEmpty(producto.resumen)
                                    ? producto.resumen
                                    : (producto.descripcion != null and !#strings.isEmpty(producto.descripcion)
                                        ? #strings.abbreviate(producto.descripcion, 180)
                                        : '')}"></p>

                        <p class="text-[#1c140d] text-sm font-normal leading-normal pb-3">
                            Precio: <span class="font-bold">S/ <span th:text="${producto.precio != null ? #numbers.formatDecimal(producto.precio, 1, 2) : '0.00'}">0.00</span></span>
                        </p>

                        <p class="text-[#9e7347] text-sm font-normal leading-normal pb-4"
                           th:text="${producto.disponible != null and producto.disponible ? 'En stock' : 'Sin stock'}">En stock</p>

                        <div class="flex gap-3 flex-wrap">
                            <button type="button"
                                    data-add-to-cart
                                    th:attr="data-producto-id=${producto.productoId}"
                                    th:disabled="${producto.disponible == null or !producto.disponible}"
                                    class="flex min-w-[140px] items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#f98006] text-[#1c140d] text-sm font-bold leading-normal tracking-[0.015em] hover:bg-[#e07305] disabled:opacity-60 disabled:cursor-not-allowed">
                                <span class="truncate">Agregar al carrito</span>
                            </button>
                            <a th:href="@{/checkout}"
                               class="flex min-w-[140px] items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#f4ede6] text-[#1c140d] text-sm font-bold leading-normal tracking-[0.015em] hover:bg-[#e9dbce]">
                                <span class="truncate">Comprar ahora</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Tabs: Descripción / Especificaciones / Envío y devoluciones -->
                <div class="px-4 pt-6">
                    <div class="flex gap-6 border-b border-solid border-b-[#f4ede6]">
                        <button type="button" id="tabDescripcion" onclick="pdpSetTab('descripcion')"
                                class="pb-3 text-[#1c140d] text-sm font-bold leading-normal">Descripción</button>
                        <button type="button" id="tabEspecificaciones" onclick="pdpSetTab('especificaciones')"
                                class="pb-3 text-[#9e7347] text-sm font-medium leading-normal">Especificaciones</button>
                        <button type="button" id="tabEnvio" onclick="pdpSetTab('envio')"
                                class="pb-3 text-[#9e7347] text-sm font-medium leading-normal">Envío y devoluciones</button>
                    </div>

                    <div id="panelDescripcion" class="pt-4">
                        <p class="text-[#1c140d] text-base font-normal leading-normal"
                           th:text="${producto.descripcion != null and !#strings.isEmpty(producto.descripcion) ? producto.descripcion : 'Sin descripción disponible.'}">Descripción</p>
                    </div>

                    <div id="panelEspecificaciones" class="pt-4 hidden">
                        <div class="grid grid-cols-1 @[720px]:grid-cols-2 gap-3">
                            <div class="flex items-center justify-between rounded-lg border border-solid border-[#f4ede6] bg-white px-4 py-3">
                                <span class="text-[#9e7347] text-sm">SKU</span>
                                <span class="text-[#1c140d] text-sm font-medium" th:text="${producto.sku != null ? producto.sku : '-'}">-</span>
                            </div>
                            <div class="flex items-center justify-between rounded-lg border border-solid border-[#f4ede6] bg-white px-4 py-3">
                                <span class="text-[#9e7347] text-sm">Categoría</span>
                                <span class="text-[#1c140d] text-sm font-medium" th:text="${producto.categoriaNombre != null ? producto.categoriaNombre : '-'}">-</span>
                            </div>
                            <div class="flex items-center justify-between rounded-lg border border-solid border-[#f4ede6] bg-white px-4 py-3">
                                <span class="text-[#9e7347] text-sm">Stock</span>
                                <span class="text-[#1c140d] text-sm font-medium" th:text="${producto.cantidad != null ? producto.cantidad : 0}">0</span>
                            </div>
                        </div>
                    </div>

                    <div id="panelEnvio" class="pt-4 hidden">
                        <p class="text-[#1c140d] text-base font-normal leading-normal">
                            Envíos a nivel nacional. El tiempo de entrega puede variar según tu ubicación.
                            Si tu pedido llega con algún problema, puedes solicitar un cambio o devolución dentro de los 7 días.
                        </p>
                    </div>
                </div>

                <!-- Productos relacionados (misma categoría) -->
                <div class="px-4 pt-10" th:if="${productosRelacionados != null and !#lists.isEmpty(productosRelacionados)}">
                    <h2 class="text-[#1c140d] text-[22px] font-bold leading-tight tracking-[-0.015em] pb-4">Productos relacionados</h2>

                    <div class="grid grid-cols-2 @[720px]:grid-cols-4 gap-4">
                        <a th:each="p : ${productosRelacionados}"
                           th:href="@{/producto/{slug}(slug=${p.slug})}"
                           class="flex flex-col gap-3 rounded-lg">
                            <div class="w-full bg-center bg-no-repeat aspect-square bg-cover rounded-lg border border-solid border-[#f4ede6]"
                                 th:with="pimg=${p.imagen != null and !#strings.isEmpty(p.imagen) ? (#strings.startsWith(p.imagen,'http') ? p.imagen : '/files/' + p.imagen) : '/files/defaults/producto-default.svg'}"
                                 th:style="'background-image: url(' + ${pimg} + ');'"></div>
                            <div>
                                <p class="text-[#1c140d] text-sm font-medium leading-normal" th:text="${p.titulo}">Relacionado</p>
                                <p class="text-[#9e7347] text-sm font-normal leading-normal">S/ <span th:text="${p.precio != null ? #numbers.formatDecimal(p.precio, 1, 2) : '0.00'}">0.00</span></p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

</main>

<th:block layout:fragment="scripts">
    <script>
        function pdpSetMainImage(btn) {
            const main = document.getElementById('pdpMainImage');
            if (!main || !btn) return;
            const src = btn.getAttribute('data-src');
            if (!src) return;
            main.setAttribute('src', src);
        }

        function pdpSetTab(tab) {
            const tabs = {
                descripcion: { tab: 'tabDescripcion', panel: 'panelDescripcion' },
                especificaciones: { tab: 'tabEspecificaciones', panel: 'panelEspecificaciones' },
                envio: { tab: 'tabEnvio', panel: 'panelEnvio' }
            };

            Object.keys(tabs).forEach((k) => {
                const t = document.getElementById(tabs[k].tab);
                const p = document.getElementById(tabs[k].panel);
                if (t) {
                    t.className = k === tab
                        ? 'pb-3 text-[#1c140d] text-sm font-bold leading-normal'
                        : 'pb-3 text-[#9e7347] text-sm font-medium leading-normal';
                }
                if (p) {
                    if (k === tab) p.classList.remove('hidden');
                    else p.classList.add('hidden');
                }
            });
        }

        // default
        pdpSetTab('descripcion');
    </script>
</th:block>

</body>
</html>
